<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AwareSync</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f7fa;
        margin: 0;
        padding: 0;
    }

    .page {
        max-width: 1000px;
        margin: 20px auto 40px;
        padding: 0 15px;
    }

    h1 {
        text-align: center;
        margin-bottom: 10px;
        color: #0a4d8c;
    }

    .subtitle-main {
        text-align: center;
        color: #555;
        margin-bottom: 20px;
        font-size: 14px;
    }

    /* Tabs */
    .tabs {
        display: flex;
        gap: 0.5rem;
        margin: 0 auto 15px;
        max-width: 900px;
    }

    .tab-button {
        flex: 1;
        padding: 0.6rem 0.8rem;
        border: none;
        border-radius: 999px;
        border-bottom: 2px solid transparent;
        background: #e5ecf6;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .tab-button.active {
        background: #0a4d8c;
        color: white;
        border-color: #083763;
    }

    .tab-content {
        max-width: 900px;
        margin: 0 auto;
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Shared card container style */
    .container {
        margin-top: 20px;
        padding: 25px;
        background: white;
        border-radius: 14px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.12);
    }

    label {
        font-weight: bold;
        margin-top: 10px;
        display: block;
    }

    input, select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-top: 5px;
        margin-bottom: 15px;
        box-sizing: border-box;
    }

    button.main-btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        background-color: #0a4d8c;
        color: white;
        cursor: pointer;
        margin-top: 10px;
        font-weight: bold;
    }

    button.main-btn:hover {
        background-color: #0c5aa3;
    }

    .section-title {
        margin-top: 35px;
        font-size: 22px;
        font-weight: bold;
        color: #0a4d8c;
        border-bottom: 2px solid #0a4d8c;
        padding-bottom: 6px;
    }

    .meal-box, .grocery-item {
        background: #f0f6ff;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .meal-header {
        font-size: 18px;
        font-weight: bold;
        color: #084a80;
    }

    .meal-items { margin-left: 15px; }

    .small-text {
        color: #555;
        font-size: 14px;
    }

    .error {
        color: red;
        margin-top: 15px;
    }

    /* Cards for events/resources */
    .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .card {
        padding: 14px;
        border-radius: 12px;
        background: #ffffff;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    .card h3 {
        margin-top: 0;
        margin-bottom: 0.25rem;
        color: #083763;
    }

    .card small {
        color: #6b7280;
    }

    .tab-subtitle {
        color: #555;
        font-size: 14px;
        margin-top: 5px;
        margin-bottom: 15px;
    }

    .tag {
        display: inline-block;
        font-size: 0.75rem;
        padding: 0.15rem 0.6rem;
        border-radius: 999px;
        background: #eff6ff;
        color: #1d4ed8;
        margin-top: 0.25rem;
    }

    a {
        color: #0a4d8c;
    }
</style>
</head>

<body>
<div class="page">
    <h1>AwareSync</h1>
    <p class="subtitle-main">
        Diabetes-friendly weekly meal planning plus local community support in one place.
    </p>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-button active" data-tab="planner">Meal Planner</button>
        <button class="tab-button" data-tab="events">Community Events</button>
        <button class="tab-button" data-tab="resources">Resources</button>
    </div>

    <!-- TAB 1: Planner -->
    <section id="tab-planner" class="tab-content active">
        <div class="container">
            <h2 style="margin-top:0; color:#0a4d8c;">Meal Planner</h2>

            <label>Weekly Budget ($)</label>
            <input id="budget" type="number" value="60" />

            <label>People in Household</label>
            <input id="people" type="number" value="1" />

            <label>Preferred Store (optional)</label>
            <input id="store" type="text" placeholder="e.g., Sprouts, Trader Joe's, Any" />

            <label>Diet Preference</label>
            <select id="diet">
                <option value="any">Any</option>
                <option value="vegetarian">Vegetarian</option>
                <option value="vegan">Vegan</option>
                <option value="white_meat_only">White Meat Only</option>
            </select>

            <label>Max Added Sugar per Meal (g)</label>
            <input id="max_added_sugar_g" type="number" value="8" />

            <label>Target Carbs per Meal (g)</label>
            <input id="target_carbs_per_meal_g" type="number" value="45" />

            <button class="main-btn" onclick="generatePlan()">Generate 7-Day Plan</button>

            <div id="results"></div>
        </div>
    </section>

    <!-- TAB 2: Events -->
    <section id="tab-events" class="tab-content">
        <div class="container">
            <h2 style="margin-top:0; color:#0a4d8c;">Community Events</h2>
            <p class="tab-subtitle">
                Diabetes-friendly walks, classes, and education events around Atlanta that support
                food access and healthier choices.
            </p>
            <div id="events-list" class="card-grid"></div>
        </div>
    </section>

    <!-- TAB 3: Resources -->
    <section id="tab-resources" class="tab-content">
        <div class="container">
            <h2 style="margin-top:0; color:#0a4d8c;">Local Resources</h2>
            <p class="tab-subtitle">
                Clinics, community programs, and food access resources that can help with diabetes
                management and budget-friendly meal planning.
            </p>
            <div id="resources-list" class="card-grid"></div>
        </div>
    </section>
</div>

<script>
  // ----- Tab switching -----
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', () => {
      // active button
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const tab = btn.dataset.tab; // 'planner' | 'events' | 'resources'

      // show/hide content
      document.querySelectorAll('.tab-content').forEach(sec => {
        if (sec.id === 'tab-' + tab) {
          sec.classList.add('active');
        } else {
          sec.classList.remove('active');
        }
      });

      if (tab === 'events') {
        loadEvents();
      } else if (tab === 'resources') {
        loadResources();
      }
    });
  });

  let eventsLoaded = false;
  let resourcesLoaded = false;

  // ----- Meal plan -----
  async function generatePlan() {
    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "";

    const storePreferenceRaw = document.getElementById("store").value.trim();

    const payload = {
        user: {
            budget: Number(document.getElementById("budget").value),
            people: Number(document.getElementById("people").value),
            diet: document.getElementById("diet").value,
            max_added_sugar_g: Number(document.getElementById("max_added_sugar_g").value),
            target_carbs_per_meal_g: Number(document.getElementById("target_carbs_per_meal_g").value),
            height_cm: 168,
            weight_kg: 75,
            activity: 0,
            restrict_low_sodium: true,
            location: "Atlanta, GA",
            store_preference: storePreferenceRaw === "" ? "any" : storePreferenceRaw
        }
    };

    let res;
    try {
        res = await fetch("http://127.0.0.1:8000/recommend", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
        });
    } catch (err) {
        resultsDiv.innerHTML =
            "<p class='error'>Failed to reach backend. Make sure Uvicorn is running.</p>";
        return;
    }

    if (!res.ok) {
        resultsDiv.innerHTML =
            "<p class='error'>Server returned an error.</p>";
        return;
    }

    const data = await res.json();

    let html = `
        <h2 class="section-title">Budget Used</h2>
        <p><b>$${data.budget_used.toFixed(2)}</b> / ${payload.user.budget}</p>

        <h2 class="section-title">7-Day Meal Plan</h2>
    `;

    data.meals.forEach(day => {
        html += `
            <div class="meal-box">
                <div class="meal-header">Day ${day.day}</div>
                <div class="meal-items small-text">
                    <b>Breakfast:</b> ${day.breakfast.join(", ")}<br>
                    <b>Lunch:</b> ${day.lunch.join(", ")}<br>
                    <b>Dinner:</b> ${day.dinner.join(", ")}
                </div>
            </div>
        `;
    });

    html += `<h2 class="section-title">Grocery List</h2>`;

    let seen = new Set();
    data.items.forEach(item => {
        const key = item.item.toLowerCase();
        if (!seen.has(key)) {
            seen.add(key);
            html += `
                <div class="grocery-item">
                    <b>${item.item}</b><br>
                    <span class="small-text">Category: ${item.category}</span><br>
                    ${item.store ? `<span class="small-text">Store: ${item.store}</span><br>` : ""}
                    <span class="small-text">Price per Serving: $${item.price_per_serving.toFixed(2)}</span><br>
                    <span class="small-text">Carbs: ${item.carbs_g} g | Protein: ${item.protein_g} g | Fiber: ${item.fiber_g} g</span><br>
                    <span class="small-text">Added Sugar: ${item.added_sugar_g} g</span><br>
                    <span class="small-text">Glycemic Impact: ${item.predicted_glycemic_impact.toFixed(2)}</span>
                </div>
            `;
        }
    });

    resultsDiv.innerHTML = html;
  }

  // ----- Fetch and render events -----
  async function loadEvents() {
    if (eventsLoaded) return;
    const container = document.getElementById('events-list');
    container.innerHTML = "<p class='small-text'>Loading events...</p>";

    try {
      const res = await fetch("http://127.0.0.1:8000/events");
      if (!res.ok) throw new Error("Failed to load events");
      const events = await res.json();
      renderEvents(events);
      eventsLoaded = true;
    } catch (err) {
      console.error(err);
      container.innerHTML = "<p class='error'>Could not load events right now.</p>";
    }
  }

  function renderEvents(events) {
    const container = document.getElementById('events-list');
    container.innerHTML = "";

    events.forEach(ev => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>${ev.title ?? ""}</h3>
        <small>${ev.date ?? ""}${ev.time ? " â€¢ " + ev.time : ""}</small>
        <p style="margin-top:0.5rem;"><strong>Location:</strong> ${ev.location ?? ""}</p>
        <p><strong>Organizer:</strong> ${ev.organizer ?? ""}</p>
        <p>${ev.description ?? ""}</p>
      `;
      container.appendChild(card);
    });
  }

  // ----- Fetch and render resources -----
  async function loadResources() {
    if (resourcesLoaded) return;
    const container = document.getElementById('resources-list');
    container.innerHTML = "<p class='small-text'>Loading resources...</p>";

    try {
      const res = await fetch("http://127.0.0.1:8000/resources");
      if (!res.ok) throw new Error("Failed to load resources");
      const resources = await res.json();
      renderResources(resources);
      resourcesLoaded = true;
    } catch (err) {
      console.error(err);
      container.innerHTML = "<p class='error'>Could not load resources right now.</p>";
    }
  }

  function renderResources(resources) {
    const container = document.getElementById('resources-list');
    container.innerHTML = "";

    resources.forEach(r => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>${r.name ?? ""}</h3>
        ${r.category ? `<span class="tag">${r.category}</span>` : ""}
        <p style="margin-top:0.5rem;"><strong>Address:</strong> ${r.address ?? ""}</p>
        <p><strong>Contact:</strong> ${r.contact ?? ""}</p>
        ${
          r.website
            ? `<p><strong>Website:</strong> <a href="${r.website}" target="_blank" rel="noopener noreferrer">${r.website}</a></p>`
            : ""
        }
        <p>${r.notes ?? ""}</p>
      `;
      container.appendChild(card);
    });
  }
</script>

</body>
</html>
